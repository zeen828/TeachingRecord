[回上層目錄](../README.md)

# 主題

## **Description [描述]**
屁話一段

## **Teaching & Examples [教學&範例]**
### 安裝
```bash
# composer安裝指令
composer require tymon/jwt-auth
```

```php
    // 設定config\app.php
    'providers' => [
        // JWT-安裝
        Tymon\JWTAuth\Providers\LaravelServiceProvider::class,
    ],
    'aliases' => [
        // JWT-安裝
        'JWTAuth' => Tymon\JWTAuth\Facades\JWTAuth::class,
        'JWTFactory' => Tymon\JWTAuth\Facades\JWTFactory::class,
    ],
```

```bash
# laravel安裝指令(生成config\jwt.php)
php artisan vendor:publish --provider="Tymon\JWTAuth\Providers\LaravelServiceProvider"
```

```bash
# laravel生成jwt使用的密鑰(寫入.env)
# JWT_SECRET=secret_jwt_string_key
php artisan jwt:secret
```

### 設定黨配置
```php
# 設定config\auth.php
    'defaults' => [
        'guard' => 'api_jwt',// 對應guards的陣列，驗證方式配置
        'passwords' => 'user_users',// 對應passwords的陣列，密碼重設配置
    ],

    'guards' => [
        'api_jwt' => [
            'driver' => 'jwt',// 驗證方式
            'provider' => 'user_users',// 對應providers的陣列，驗整資料配置
            'hash' => false,
        ],
    ],

    'providers' => [
        'user_users' => [
            'driver' => 'eloquent',// 資料取得方式
            'model' => App\Models\User\User::class,// 模型位置
        ],
    ],

    'passwords' => [
        'user_users' => [
            'provider' => 'user_users',// 對應providers的陣列，驗整資料配置
            'table' => 'password_resets',
            'expire' => 60,
            'throttle' => 60,
        ],
    ],
```

### 模型(Model)配置
```php
// 模型驗證設定，範例使用App\Models\User\User.php
namespace App\Models\User;

use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
// JWT
use Tymon\JWTAuth\Contracts\JWTSubject;

// class User extends Authenticatable
class User extends Authenticatable implements JWTSubject
{
    use HasFactory, Notifiable;

    // 資料庫名稱
    protected $table = 'users';

    // 欄位名稱
    protected $fillable = [
        'name', 'email', 'password',
    ];

    // 隱藏不顯示欄位
    protected $hidden = [
        'password', 'remember_token',
    ];

    // 未查
    protected $casts = [
        'email_verified_at' => 'datetime',
    ];

    // 獲取將存儲在JWT的主題聲明中的標識符。
    public function getJWTIdentifier() {
        return $this->getKey();
    }

    // 返回一個鍵值數組，其中包含要添加到JWT的所有自定義聲明。
    public function getJWTCustomClaims() {
        return [];
    }
}
```

### 控制器(Controller)配置
```php
// 控制器設定，範例使用App\Http\Controllers\Demo\AuthController.php
namespace App\Http\Controllers\Demo;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Auth;
use App\Models\User\User;

class AuthController extends Controller
{
    // 建構子
    public function __construct() {
        $this->middleware('auth:api_jwt', ['except' => ['login', 'register']]);
    }

    // 登入
    public function login(Request $request){
    	$validator = Validator::make($request->all(), [
            'email' => 'required|email',
            'password' => 'required|string|min:6',
        ]);

        if ($validator->fails()) {
            return response()->json($validator->errors(), 422);
        }

        if (! $token = Auth::attempt($validator->validated())) {
            return response()->json(['error' => 'Unauthorized'], 401);
        }

        return $this->createNewToken($token);
    }

    // 註冊
    public function register(Request $request) {
        $validator = Validator::make($request->all(), [
            'name' => 'required|string|between:2,100',
            'email' => 'required|string|email|max:100|unique:users',
            'password' => 'required|string|min:6',
        ]);

        if($validator->fails()){
            return response()->json($validator->errors()->toJson(), 400);
        }

        $user = User::create(array_merge(
                    $validator->validated(),
                    ['password' => bcrypt($request->password)]
                ));

        return response()->json([
            'message' => 'User successfully registered',
            'user' => $user
        ], 201);
    }

    // 登出
    public function logout() {
        Auth::logout();

        return response()->json(['message' => 'User successfully signed out']);
    }

    // 刷新Token
    public function refresh() {
        return $this->createNewToken(Auth::refresh());
    }

    // 使用者資料
    public function userProfile() {
        return response()->json(Auth::user());
    }

    // 建立新的Token
    protected function createNewToken($token){
        return response()->json([
            'access_token' => $token,
            'token_type' => 'bearer',
            'expires_in' => Auth::factory()->getTTL() * 60,
            'user' => Auth::user()
        ]);
    }
}
```

### 路由配置
```php
Route::group([
    'middleware' => 'api',
    'prefix' => 'auth'
], function ($router) {
    // 登入
    Route::post('/login', [AuthController::class, 'login']);
    // 註冊
    Route::post('/register', [AuthController::class, 'register']);
    // 登出
    Route::post('/logout', [AuthController::class, 'logout']);
    // 更新Token
    Route::post('/refresh', [AuthController::class, 'refresh']);
    // 用戶資料
    Route::get('/user-profile', [AuthController::class, 'userProfile']);    
});
```

## **Reference article [參考文章]**
[參考文件](https://www.positronx.io/laravel-jwt-authentication-tutorial-user-login-signup-api/)
[參考文件](https://www.avyatech.com/rest-api-with-laravel-8-using-jwt-token/)

## **Author [作者]**
`Mr. Will`
